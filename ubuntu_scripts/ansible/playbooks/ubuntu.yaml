---
- hosts: all
  remote_user: bruno
  become: true
  vars:
    tailscale_advertise_exit_node: true
    tailscale_up_args: "{{ '--advertise-exit-node' if tailscale_advertise_exit_node else '' }}"
  tasks:
    - name: "Update and upgrade all packages to the latest version"
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        cache_valid_time: 3600

    - name: "Install required packages"
      ansible.builtin.apt:
        pkg:
          - apt-transport-https
          - ca-certificates
          - curl
          - vim
          - gnupg
          - software-properties-common
          - net-tools
          - htop
          - gh

    - name: "Create directory for APT keyrings"
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: "Add Tailscale apt signing key"
      ansible.builtin.get_url:
        url: "https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_facts['lsb']['codename'] }}.noarmor.gpg"
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'

    - name: "Add Tailscale apt repository"
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ ansible_facts['lsb']['codename'] }} main"
        filename: tailscale
        state: present

    - name: "Install Tailscale"
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true

    - name: "Enable and start tailscaled"
      ansible.builtin.systemd:
        name: tailscaled
        enabled: true
        state: started

    - name: "Enable IPv4 forwarding (required for exit node)"
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: true

    - name: "Enable IPv6 forwarding (required for exit node)"
      ansible.posix.sysctl:
        name: net.ipv6.conf.all.forwarding
        value: '1'
        state: present
        reload: true

    - name: "Check current Tailscale status"
      ansible.builtin.command: tailscale status --json
      register: tailscale_status
      changed_when: false
      failed_when: false

    - name: "Bring Tailscale up (only if not already running)"
      ansible.builtin.command: "tailscale up --auth-key={{ tailscale_auth_key }} {{ tailscale_up_args }}"
      no_log: true
      when:
        - tailscale_auth_key is defined
        - (tailscale_status.rc | int) != 0 or ((tailscale_status.stdout | default('{}') | from_json).BackendState | default('')) != 'Running'

    - name: "Create directory for Docker's GPG key"
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: "Add Docker's official GPG key"
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        keyring: /etc/apt/keyrings/docker.gpg
        state: present

    - name: "Print architecture variables"
      ansible.builtin.debug:
        msg: >-
          Architecture: {{ ansible_facts['architecture'] }},
          Codename: {{ ansible_facts['lsb']['codename'] }}

    - name: "Add Docker repository"
      ansible.builtin.apt_repository:
        repo: >-
          deb [arch={{ arch_mapping[ansible_facts['architecture']] | default(ansible_facts['architecture']) }}
          signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu {{ ansible_facts['lsb']['codename'] }} stable
        filename: docker
        state: present

    - name: "Install Docker and related packages"
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
        - docker-compose-plugin

    - name: "Add Docker group"
      ansible.builtin.group:
        name: docker
        state: present

    - name: "Add user to Docker group"
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: "Enable and start Docker services"
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - docker.service
        - containerd.service

    ### NAS Directory Configuration
    - name: "Create directory to NAS Mount"
      ansible.builtin.file:
        path: /mnt/zimacube
        state: directory
        mode: '0755'

    - name: "Copy credential file to Server"
      ansible.builtin.copy:
        src: "{{ inventory_dir }}/{{ item }}"
        dest: /home/{{ ansible_user }}/{{ item }}
      loop:
      - .credentials

    - name: "Install required packages"
      ansible.builtin.apt:
        pkg:
          - cifs-utils

    - name: Check if resolv.conf file exists
      stat:
          path: /etc/resolv.conf
      register: file_info

    - name: Create /etc/resolv.conf if it exists
      file:
        path: /etc/resolv.conf
        state: touch
      when: not file_info.stat.exists

    - name: Set DNS nameservers in /etc/resolv.conf
      blockinfile:
          path: /etc/resolv.conf
          block: |
                nameserver 8.8.8.8
                nameserver 8.8.4.4

    ## https://dubnik.wordpress.com/2020/03/31/how-to-mount-cifs-ansible/
    - name: "Mount NAS Directory"
      mount:
        state: "mounted"
        fstype: "cifs"
        name: /mnt/zimacube/
        src: "//192.168.0.189/Bruno"
        opts: "credentials=/home/bruno/.credentials,file_mode=0644,dir_mode=0755,gid=bruno,uid=bruno"

    # - name: Unmount
    #   mount:
    #     path: /mnt/zimacube/
    #     state: unmounted

    ### Copy Compose files and Start them
    - name: "Copy Portainer Docker Compose files"
      ansible.builtin.copy:
        src: "{{ inventory_dir }}/docker/{{ item }}"
        dest: /home/{{ ansible_user }}/{{ item }}
      loop:
      - media-compose.yaml
      - utils-compose.yaml

    - name: "Deploy Media Docker Compose stack"
      community.docker.docker_compose_v2:
        project_name: media
        project_src: /home/{{ ansible_user }}
        remove_orphans: true
        files:
        - media-compose.yaml

    - name: "Deploy Utils Docker Compose stack"
      community.docker.docker_compose_v2:
        project_name: utils
        project_src: /home/{{ ansible_user }}
        remove_orphans: true
        files:
        - utils-compose.yaml
